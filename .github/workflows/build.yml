name: Build ZenSei Platinum APK
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Generate Project & Apply Fixes
        run: |
          # 1. CLEANUP & BACKUP
          echo "Backing up custom files..."
          mkdir -p ~/safe_keep
          mv pubspec.yaml ~/safe_keep/
          mv main.dart ~/safe_keep/
          mv icon.png ~/safe_keep/ 2>/dev/null || true
          
          echo "Nuking old Android folder to force regeneration..."
          rm -rf android
          rm -rf ios
          rm -rf web
          rm -rf lib
          
          # 2. GENERATE NEW PROJECT
          echo "Generating fresh Flutter project..."
          flutter create . --org org.zensei --project-name zensei_player
          
          # 3. RESTORE CUSTOM FILES
          echo "Restoring custom code..."
          mv ~/safe_keep/pubspec.yaml .
          mv ~/safe_keep/main.dart lib/main.dart
          mv ~/safe_keep/icon.png . 2>/dev/null || true
          rm -rf ~/safe_keep
          
          # 4. VERIFY FILES EXIST
          if [ ! -f "android/app/build.gradle" ]; then
            echo "CRITICAL ERROR: android/app/build.gradle was not generated!"
            exit 1
          fi

          # 5. APPLY FIXES (Java Version, App Name, Permissions)
          echo "Applying patches..."

          # Fix A: Force Java 17 Compatibility (Fixes the 'Inconsistent JVM' error)
          # We insert the compile options right before 'defaultConfig'
          sed -i '/defaultConfig {/i \
            compileOptions {\n\
                sourceCompatibility JavaVersion.VERSION_17\n\
                targetCompatibility JavaVersion.VERSION_17\n\
            }\n\
            kotlinOptions {\n\
                jvmTarget = "17"\n\
            }' android/app/build.gradle

          # Fix B: Inject Permissions (Manifest)
          sed -i 's|<application|<uses-permission android:name="android.permission.INTERNET"/>\n    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>\n    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO"/>\n    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/>\n    <application|' android/app/src/main/AndroidManifest.xml

          # Fix C: Rename App to "ZenSei" (Manifest)
          sed -i 's/android:label="zensei_player"/android:label="ZenSei"/g' android/app/src/main/AndroidManifest.xml

          # Fix D: Repair 'on_audio_query' Plugin (Namespace Error)
          # We find the file in the cache and patch it
          flutter pub get
          FILE=$(find ~/.pub-cache/hosted/pub.dev -name "build.gradle" | grep "on_audio_query_android")
          if [ -f "$FILE" ]; then
             echo "Patching Plugin at $FILE"
             sed -i 's/android {/android { namespace "com.lucasjosino.on_audio_query"/' "$FILE"
          fi

      - name: Generate App Icon
        run: flutter pub run flutter_launcher_icons

      - name: Build APK
        run: flutter build apk --release --no-shrink

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ZenSei
          path: build/app/outputs/flutter-apk/app-release.apk
          
